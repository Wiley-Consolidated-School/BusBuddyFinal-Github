#nullable disable
using System;
using System.Collections.Generic;
using System.Reflection;
using BusBuddy.Data;
using BusBuddy.Models;
using BusBuddy.UI.Views;
using BusBuddy.Tests.UI;
using Moq;
using Xunit;

namespace BusBuddy.Tests
{
    /// <summary>
    /// Tests to verify that management forms handle null values safely
    /// and don't throw ArgumentNullException when repositories return null
    /// </summary>
    public class NullSafetyTests : UITestBase
    {
        [Fact]
        public void VehicleManagementForm_LoadData_ShouldHandleNullRepository()
        {
            // Arrange
            var mockRepo = new Mock<IVehicleRepository>();
            mockRepo.Setup(r => r.GetAllVehicles()).Returns((List<Vehicle>)null);

            // Act & Assert - Should not throw ArgumentNullException
            var form = new VehicleManagementFormSyncfusion(mockRepo.Object);

            // Invoke LoadData via reflection
            var loadDataMethod = typeof(VehicleManagementFormSyncfusion)
                .GetMethod("LoadData", BindingFlags.NonPublic | BindingFlags.Instance);

            // This should not throw an exception
            var exception = Record.Exception(() => loadDataMethod?.Invoke(form, null));
            Assert.Null(exception);

            form.Dispose();
        }

        [Fact]
        public void DriverManagementForm_LoadData_ShouldHandleNullRepository()
        {
            // Arrange
            var mockRepo = new Mock<IDriverRepository>();
            mockRepo.Setup(r => r.GetAllDrivers()).Returns((List<Driver>)null);

            // Act & Assert
            var form = new DriverManagementFormSyncfusion(mockRepo.Object);

            // Invoke LoadData via reflection
            var loadDataMethod = typeof(DriverManagementFormSyncfusion)
                .GetMethod("LoadData", BindingFlags.NonPublic | BindingFlags.Instance);

            // This should not throw an exception
            var exception = Record.Exception(() => loadDataMethod?.Invoke(form, null));
            Assert.Null(exception);

            form.Dispose();
        }

        [Fact]
        public void RouteManagementForm_LoadData_ShouldHandleNullRepository()
        {
            // Arrange
            var mockRepo = new Mock<IRouteRepository>();
            mockRepo.Setup(r => r.GetAllRoutes()).Returns((List<Route>)null);
            var mockVehicleRepo = new Mock<IVehicleRepository>();
            var mockDriverRepo = new Mock<IDriverRepository>();

            // Act & Assert
            var form = new RouteManagementFormSyncfusion(mockRepo.Object, mockVehicleRepo.Object, mockDriverRepo.Object);

            // Invoke LoadData via reflection
            var loadDataMethod = typeof(RouteManagementFormSyncfusion)
                .GetMethod("LoadData", BindingFlags.NonPublic | BindingFlags.Instance);

            // This should not throw an exception
            var exception = Record.Exception(() => loadDataMethod?.Invoke(form, null));
            Assert.Null(exception);

            form.Dispose();
        }

        [Fact]
        public void MaintenanceManagementForm_LoadData_ShouldHandleNullRepository()
        {
            // Arrange
            var mockRepo = new Mock<IMaintenanceRepository>();
            mockRepo.Setup(r => r.GetAllMaintenanceRecords()).Returns((List<Maintenance>)null);
            var mockVehicleRepo = new Mock<IVehicleRepository>();

            // Act & Assert
            var form = new MaintenanceManagementFormSyncfusion(mockRepo.Object, mockVehicleRepo.Object);

            // Invoke LoadData via reflection
            var loadDataMethod = typeof(MaintenanceManagementFormSyncfusion)
                .GetMethod("LoadData", BindingFlags.NonPublic | BindingFlags.Instance);

            // This should not throw an exception
            var exception = Record.Exception(() => loadDataMethod?.Invoke(form, null));
            Assert.Null(exception);

            form.Dispose();
        }

        [Fact]
        public void FuelManagementForm_LoadData_ShouldHandleNullRepository()
        {
            // Arrange
            var mockRepo = new Mock<IFuelRepository>();
            mockRepo.Setup(r => r.GetAllFuelRecords()).Returns((List<Fuel>)null);
            var mockVehicleRepo = new Mock<IVehicleRepository>();

            // Act & Assert - Using explicit cast for proper typing
            var form = new FuelManagementFormSyncfusion((FuelRepository)mockRepo.Object, (VehicleRepository)mockVehicleRepo.Object);

            // Invoke LoadData via reflection
            var loadDataMethod = typeof(FuelManagementFormSyncfusion)
                .GetMethod("LoadData", BindingFlags.NonPublic | BindingFlags.Instance);

            // This should not throw an exception
            var exception = Record.Exception(() => loadDataMethod?.Invoke(form, null));
            Assert.Null(exception);

            form.Dispose();
        }

        [Fact]
        public void ActivityManagementForm_LoadData_ShouldHandleNullRepository()
        {
            // Arrange
            var mockRepo = new Mock<IActivityRepository>();
            mockRepo.Setup(r => r.GetAllActivities()).Returns((List<Activity>)null);

            // Act & Assert
            var form = new ActivityManagementFormSyncfusion(mockRepo.Object);

            // Invoke LoadData via reflection
            var loadDataMethod = typeof(ActivityManagementFormSyncfusion)
                .GetMethod("LoadData", BindingFlags.NonPublic | BindingFlags.Instance);

            // This should not throw an exception
            var exception = Record.Exception(() => loadDataMethod?.Invoke(form, null));
            Assert.Null(exception);

            form.Dispose();
        }
    }
}
